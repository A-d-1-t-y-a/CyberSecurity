@echo off
REM Malware Detection Testing Script for Windows
REM Author: Manoj Santhoju
REM Institution: National College of Ireland

echo ==========================================
echo MALWARE DETECTION TESTING SCRIPT
echo ==========================================
echo.
echo WARNING: This script simulates malware-like behaviors
echo for testing purposes only. Use in isolated environments.
echo.
pause

REM Activate virtual environment
echo [1] Activating virtual environment...
if exist venv\Scripts\activate.bat (
    call venv\Scripts\activate.bat
    echo SUCCESS: Virtual environment activated
) else (
    echo ERROR: Virtual environment not found
    echo Please run setup_windows.bat first
    pause
    exit /b 1
)

REM Run malware simulation
echo.
echo [2] Running malware simulation...
py test_malware_simulation.py
if %errorlevel% neq 0 (
    echo ERROR: Malware simulation failed
    pause
    exit /b 1
)
echo SUCCESS: Malware simulation completed

REM Wait for memory dump creation
echo.
echo [3] Waiting for memory dump creation...
echo.
echo INSTRUCTIONS:
echo 1. Create a memory dump now using your preferred method:
echo    - WinPmem: winpmem.exe -o memory_dump_with_malware.raw
echo    - DumpIt: dumpit.exe /O memory_dump_with_malware.raw
echo    - VM Snapshot: Create VM memory snapshot
echo.
echo 2. Place the memory dump in the current directory
echo.
echo 3. Press any key when memory dump is ready...
pause

REM Check if memory dump exists
echo.
echo [4] Checking for memory dump...
set DUMP_FILE=
for %%f in (memory_dump_with_malware.* *.raw *.dmp *.mem) do (
    if exist "%%f" (
        set DUMP_FILE=%%f
        echo Found memory dump: %%f
        goto :found_dump
    )
)

echo ERROR: No memory dump found
echo Please create a memory dump and place it in the current directory
pause
exit /b 1

:found_dump

REM Determine OS type
echo.
echo [5] Determining OS type...
echo Please select the OS type for the memory dump:
echo 1. Windows
echo 2. Linux
echo 3. macOS
set /p OS_CHOICE="Enter choice (1-3): "

if "%OS_CHOICE%"=="1" set OS_TYPE=windows
if "%OS_CHOICE%"=="2" set OS_TYPE=linux
if "%OS_CHOICE%"=="3" set OS_TYPE=macos

if "%OS_TYPE%"=="" (
    echo ERROR: Invalid OS type
    pause
    exit /b 1
)

echo Selected OS type: %OS_TYPE%

REM Run analysis
echo.
echo [6] Running memory forensics analysis...
py -m unified_forensics analyze "%DUMP_FILE%" --os-type %OS_TYPE% --plugins malware,network --format summary --metrics
if %errorlevel% neq 0 (
    echo ERROR: Analysis failed
    pause
    exit /b 1
)
echo SUCCESS: Analysis completed

REM Run experimental analysis
echo.
echo [7] Running experimental analysis...
py -m unified_forensics experiment "%DUMP_FILE%" --os-type %OS_TYPE% --rates 1 --rates 10 --output analysis_results\malware_detection_test.json
if %errorlevel% neq 0 (
    echo WARNING: Experimental analysis failed (non-critical)
) else (
    echo SUCCESS: Experimental analysis completed
)

REM Display results
echo.
echo [8] Displaying results...
echo.
echo ==========================================
echo ANALYSIS RESULTS
echo ==========================================
echo.
if exist analysis_results\*.json (
    echo Recent analysis results:
    dir /b analysis_results\*.json | findstr /i "malware detection"
) else (
    echo No analysis results found
)

REM Ask about cleanup
echo.
echo [9] Cleanup...
set /p CLEANUP="Do you want to clean up test artifacts? (y/n): "
if /i "%CLEANUP%"=="y" (
    py test_malware_simulation.py --cleanup
    echo SUCCESS: Cleanup completed
) else (
    echo Test artifacts preserved for review
)

echo.
echo ==========================================
echo TESTING COMPLETE
echo ==========================================
echo.
echo Results saved in:
echo   - analysis_results\
echo   - performance_charts\
echo   - malware_test_environment\
echo.
echo Review the results for malware detection accuracy.
echo.
pause
