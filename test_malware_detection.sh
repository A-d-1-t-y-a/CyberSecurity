#!/bin/bash

# Malware Detection Testing Script for Linux/macOS
# Author: Manoj Santhoju
# Institution: National College of Ireland

echo "=========================================="
echo "MALWARE DETECTION TESTING SCRIPT"
echo "=========================================="
echo ""
echo "WARNING: This script simulates malware-like behaviors"
echo "for testing purposes only. Use in isolated environments."
echo ""
read -p "Press Enter to continue..."

# Activate virtual environment
echo ""
echo "[1] Activating virtual environment..."
if [ -d "venv" ]; then
    source venv/bin/activate
    if [ $? -eq 0 ]; then
        echo "SUCCESS: Virtual environment activated"
    else
        echo "ERROR: Failed to activate virtual environment"
        exit 1
    fi
else
    echo "ERROR: Virtual environment not found"
    echo "Please run ./setup_linux.sh or ./setup_macos.sh first"
    exit 1
fi

# Run malware simulation
echo ""
echo "[2] Running malware simulation..."
python3 test_malware_simulation.py
if [ $? -ne 0 ]; then
    echo "ERROR: Malware simulation failed"
    exit 1
fi
echo "SUCCESS: Malware simulation completed"

# Wait for memory dump creation
echo ""
echo "[3] Waiting for memory dump creation..."
echo ""
echo "INSTRUCTIONS:"
echo "1. Create a memory dump now using your preferred method:"
echo "   - Volatility: sudo volatility3 -f /dev/mem -o memory_dump_with_malware.raw"
echo "   - VM Snapshot: Create VM memory snapshot"
echo "   - LiME: sudo insmod lime.ko path=/tmp/memory_dump_with_malware.raw format=raw"
echo ""
echo "2. Place the memory dump in the current directory"
echo ""
read -p "3. Press Enter when memory dump is ready..."

# Check if memory dump exists
echo ""
echo "[4] Checking for memory dump..."
DUMP_FILE=""

for file in memory_dump_with_malware.* *.raw *.dmp *.mem; do
    if [ -f "$file" ]; then
        DUMP_FILE="$file"
        echo "Found memory dump: $file"
        break
    fi
done

if [ -z "$DUMP_FILE" ]; then
    echo "ERROR: No memory dump found"
    echo "Please create a memory dump and place it in the current directory"
    exit 1
fi

# Determine OS type
echo ""
echo "[5] Determining OS type..."
echo "Please select the OS type for the memory dump:"
echo "1. Windows"
echo "2. Linux"
echo "3. macOS"
read -p "Enter choice (1-3): " OS_CHOICE

case $OS_CHOICE in
    1)
        OS_TYPE="windows"
        ;;
    2)
        OS_TYPE="linux"
        ;;
    3)
        OS_TYPE="macos"
        ;;
    *)
        echo "ERROR: Invalid OS type"
        exit 1
        ;;
esac

echo "Selected OS type: $OS_TYPE"

# Run analysis
echo ""
echo "[6] Running memory forensics analysis..."
python3 -m unified_forensics analyze "$DUMP_FILE" --os-type "$OS_TYPE" --plugins malware,network --format summary --metrics
if [ $? -ne 0 ]; then
    echo "ERROR: Analysis failed"
    exit 1
fi
echo "SUCCESS: Analysis completed"

# Run experimental analysis
echo ""
echo "[7] Running experimental analysis..."
python3 -m unified_forensics experiment "$DUMP_FILE" --os-type "$OS_TYPE" --rates 1 --rates 10 --output "analysis_results/malware_detection_test.json"
if [ $? -ne 0 ]; then
    echo "WARNING: Experimental analysis failed (non-critical)"
else
    echo "SUCCESS: Experimental analysis completed"
fi

# Display results
echo ""
echo "[8] Displaying results..."
echo ""
echo "=========================================="
echo "ANALYSIS RESULTS"
echo "=========================================="
echo ""
if ls analysis_results/*.json 1> /dev/null 2>&1; then
    echo "Recent analysis results:"
    ls -t analysis_results/*.json | grep -i "malware\|detection" | head -5
else
    echo "No analysis results found"
fi

# Ask about cleanup
echo ""
echo "[9] Cleanup..."
read -p "Do you want to clean up test artifacts? (y/n): " CLEANUP
if [ "$CLEANUP" = "y" ] || [ "$CLEANUP" = "Y" ]; then
    python3 test_malware_simulation.py --cleanup
    echo "SUCCESS: Cleanup completed"
else
    echo "Test artifacts preserved for review"
fi

echo ""
echo "=========================================="
echo "TESTING COMPLETE"
echo "=========================================="
echo ""
echo "Results saved in:"
echo "  - analysis_results/"
echo "  - performance_charts/"
echo "  - malware_test_environment/"
echo ""
echo "Review the results for malware detection accuracy."
echo ""
